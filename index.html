<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DC24V 電圧降下計算ツール</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
  header { display: flex; align-items: center; margin-bottom: 10px; }
  header img { height: 50px; margin-right: 15px; }
  header h1 { font-size: 22px; margin: 0; }

  #conditions, #projectInfo {
    background: #eef5ff;
    padding: 10px 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
  }

  input[type=text] { width: 200px; margin-left: 10px; }

  table { border-collapse: collapse; width: 100%; margin: 10px 0; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 13px; }
  th { background: #eee; }
  .warning { color: red; font-weight: bold; }

  button { padding: 6px 10px; border: none; color: white; border-radius: 6px; cursor: pointer; margin: 4px; }
  .add-btn { background-color: #007bff; }
  .remove-btn { background-color: #dc3545; }
  .calc-btn { background-color: #198754; }
  .print-btn { background-color: #6c757d; }
  button:hover { opacity: 0.85; }

  @page { size: A4 portrait; margin: 15mm; }
  @media print {
    button, header, #circuits, #conditions, #projectInfo { display: none !important; }
    #printHeader {
      display: block !important;
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%;
      background: white;
      border-bottom: 2px solid #ccc;
      padding: 5px 15px;
    }
    #result { margin-top: 130px; }
  }
  #printHeader { display: none; }
</style>
</head>
<body>

<header>
  <img src="三協アルミ_4C透過.png" alt="ロゴ">
  <h1>DC24V 電圧降下計算ツール</h1>
</header>

<div id="projectInfo">
  <strong>■ 物件情報</strong><br>
  物件名：<input type="text" id="projectName" placeholder="例：○○邸 外構照明計画"><br>
  作成担当者：<input type="text" id="creator" placeholder="例：三協 太郎">
</div>

<div id="conditions">
  <strong>■ 条件設定</strong><br>
  トランス電圧：<b>DC24V</b>　
  電圧降下定数：<b>0.00126 V/W・m</b>　　
  許容電圧降下：<b>2.0V</b><br>
  トランス容量：
  <select id="transformer">
    <option value="35">35W</option>
    <option value="75">75W</option>
  </select>
</div>

<div id="printHeader">
  <img src="三協アルミ_4C透過.png" alt="ロゴ" style="height:35px; vertical-align:middle; margin-right:10px;">
  <span style="font-size:18px; font-weight:bold;">DC24V 電圧降下計算ツール</span><br>
  <small id="printConditions"></small><br>
  <small id="printProjectInfo"></small>
</div>

<div>
  <button class="add-btn" onclick="addCircuit()">＋ ライン追加</button>
</div>

<div id="circuits"></div>

<div>
  <button class="calc-btn" onclick="calc()">計算する</button>
  <button class="print-btn" onclick="preparePrint()">印刷（PDF保存可）</button>
</div>

<div id="result"></div>

<script>
  const DROP_PER_M = 0.00126;
  const MAX_CIRCUITS = 4;
  const MAX_BRANCHES = 4;
  const circuitsDiv = document.getElementById("circuits");

  function addCircuit() {
    if (circuitsDiv.children.length >= MAX_CIRCUITS) {
      alert("最大4ラインまで追加できます。");
      return;
    }
    const wrapper = document.createElement("div");
    wrapper.className = "circuit";
    wrapper.innerHTML = `
      <h2>ライン ${circuitsDiv.children.length + 1}
        <button class="remove-btn" onclick="removeCircuit(this)">ライン削除</button>
      </h2>
      <div class="branches"></div>
      <button class="add-btn" onclick="addBranch(this)">＋ 分岐追加</button>
    `;
    circuitsDiv.appendChild(wrapper);
    updateCircuitNumbers();
  }

  function removeCircuit(btn) {
    btn.closest(".circuit").remove();
    updateCircuitNumbers();
  }

  function updateCircuitNumbers() {
    document.querySelectorAll(".circuit").forEach((c, idx) => {
      c.querySelector("h2").innerHTML = `ライン ${idx + 1}
        <button class='remove-btn' onclick='removeCircuit(this)'>ライン削除</button>`;
    });
  }

  function addBranch(btn) {
    const branchesDiv = btn.parentNode.querySelector(".branches");
    const circuitIndex = Array.from(circuitsDiv.children).indexOf(btn.closest(".circuit")) + 1;

    if (branchesDiv.children.length >= MAX_BRANCHES) {
      alert("分岐は最大4つまでです。");
      return;
    }

    const branchWrapper = document.createElement("div");
    branchWrapper.className = "branch";
    branchWrapper.innerHTML = `
      <h3>分岐 ${circuitIndex}-${branchesDiv.children.length + 1}
        <button class="remove-btn" onclick="removeBranch(this)">分岐削除</button>
      </h3>
      <table>
        <thead>
          <tr><th>番号</th><th>名称・記号</th><th>消費電力(W)</th><th>コード長さ(m)</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="add-btn" onclick="addLamp(this)">＋ 照明追加</button>
    `;
    branchesDiv.appendChild(branchWrapper);
    updateBranchNumbers(branchesDiv, circuitIndex);
  }

  function removeBranch(btn) {
    const branchesDiv = btn.closest(".branches");
    const circuitIndex = Array.from(circuitsDiv.children).indexOf(btn.closest(".circuit")) + 1;
    btn.closest(".branch").remove();
    updateBranchNumbers(branchesDiv, circuitIndex);
  }

  function updateBranchNumbers(branchesDiv, circuitIndex) {
    branchesDiv.querySelectorAll(".branch").forEach((b, idx) => {
      b.querySelector("h3").innerHTML = `分岐 ${circuitIndex}-${idx + 1}
        <button class='remove-btn' onclick='removeBranch(this)'>分岐削除</button>`;
    });
  }

  function addLamp(btn) {
    const tbody = btn.parentNode.querySelector("tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${tbody.children.length + 1}</td>
      <td><input type="text" class="name" style="width:100px;"></td>
      <td><input type="number" class="watt" min="0" step="0.1" style="width:70px;"></td>
      <td><input type="number" class="len" min="0" step="0.1" style="width:70px;"></td>
      <td><button class="remove-btn" onclick="removeLamp(this)">削除</button></td>
    `;
    tbody.appendChild(tr);
    updateLampNumbers(tbody);
  }

  function removeLamp(btn) {
    const tbody = btn.closest("tbody");
    btn.closest("tr").remove();
    updateLampNumbers(tbody);
  }

  function updateLampNumbers(tbody) {
    tbody.querySelectorAll("tr").forEach((tr, i) => {
      tr.children[0].textContent = i + 1;
    });
  }

  function calc() {
    const transformer = parseFloat(document.getElementById("transformer").value);
    let totalW = 0;
    let lineResults = "";
    let overallResult = "<h2>計算結果</h2>";

    const circuits = document.querySelectorAll(".circuit");

    circuits.forEach((c, cIdx) => {
      let circuitW = 0;
      let circuitHtml = `<h3>ライン ${cIdx + 1}</h3>`;
      const branches = c.querySelectorAll(".branch");

      branches.forEach((b, bIdx) => {
        let branchW = 0;
        let branchDrop = 0;
        let branchRows = "";
        const rows = b.querySelectorAll("tbody tr");

        rows.forEach((r, idx) => {
          const name = r.querySelector(".name").value || "-";
          const w = parseFloat(r.querySelector(".watt").value) || 0;
          const len = parseFloat(r.querySelector(".len").value) || 0;
          const drop = w * len * DROP_PER_M;
          branchW += w;
          branchDrop += drop;
          branchRows += `
            <tr><td>${idx + 1}</td><td>${name}</td><td>${w.toFixed(2)}</td><td>${len.toFixed(1)}</td><td>${drop.toFixed(2)}</td></tr>`;
        });

        circuitW += branchW;
        circuitHtml += `
          <h4>分岐 ${cIdx + 1}-${bIdx + 1}</h4>
          <table>
            <tr><th>番号</th><th>品名・名称</th><th>W数</th><th>コード長さ(m)</th><th>電圧降下(V)</th></tr>
            ${branchRows}
          </table>
          <p><b>分岐 ${cIdx + 1}-${bIdx + 1} 小計:</b> ${branchW.toFixed(2)} W, 電圧降下 ${branchDrop.toFixed(2)} V</p>
        `;
      });

      totalW += circuitW;
      circuitHtml += `<p><b>ライン${cIdx + 1} 小計:</b> ${circuitW.toFixed(2)} W</p><hr>`;
      lineResults += circuitHtml;
    });

    overallResult += `<p><b>合計消費電力:</b> ${totalW.toFixed(2)} W</p>`;
    if (totalW > transformer) {
      overallResult += `<p class="warning">⚠ トランス容量（${transformer}W）を超えています！</p>`;
    }

    const creator = document.getElementById("creator").value || "未入力";
    const date = new Date().toLocaleDateString();
    

    document.getElementById("result").innerHTML = overallResult + lineResults;
  }

  function preparePrint() {
    const project = document.getElementById("projectName").value || "未入力";
    const creator = document.getElementById("creator").value || "未入力";
    const transformer = document.getElementById("transformer").value;
    document.getElementById("printConditions").innerText =
      `トランス電圧：DC24V　|　電圧降下定数：0.00126　|　許容電圧降下：2.0V　|　トランス容量：${transformer}W`;
    document.getElementById("printProjectInfo").innerText =
      `物件名：${project}　|　作成担当者：${creator}  |　作成日: ${new Date().toLocaleDateString()}`;
    window.print();
  }
</script>
</body>
</html>
